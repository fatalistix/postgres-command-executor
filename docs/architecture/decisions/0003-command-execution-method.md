# 3. Command execution method

Date: 2024-05-03

## Status

Accepted

## Context

Понятие "команда" вызвало вопросы. Самый главный вопрос - что значит "создать команду"? Чем отличается создание команды от ее исполнения? Как к этому еще добавить "параллельный запуск" команд? А остановку и остальные дополнительные требования? Но больше всего сбивает первый главный вопрос.

## Decision

Разделить приложение на две сущности: команду и процесс. 

### Команда

Команда будет представлять собой код bash-скрипта, будет являться своеобразным образом исполняемой сущности. Это позволяет нам применить стандартные CRUD операции над командами, по факту выполнив основные функциональные требования (на момент принятия решения, то есть конец апреля/начало мая).

### Процесс

Параллелизм в запуске команд будет достигаться на уровне процессов. Терминология взята из устройства операционных систем. 

Для запуска процесса пользователю достаточно отправить на end-point POST запрос, содержащий идентификатор команды, которую он хочет запустить. После этого асинхронно запустится bash-скрипт, а пользователю вернется идентификатор запущенного процесса, с помощью которого можно этим процессом и управлять

Таким образом, при получении двух POST запросов, просто произойдет создание двух процессов, исполняющих одинаковые команды.

Поэтапно распишем, как это можно реализовать:

1. по идентификатору из базы данных извлекается код команды
2. подготавливается запись процесса в бд
3. подготавливается исполнение команды/процесса: создается экземпляр процесса, создаются pipe для stdout и stderr
4. если подготовка прошла без ошибок, то процесс запускается в отдельной рутине
5. объекты, являющиеся отражением процесса в коде, сохраняются в контейнер, который разделяется между сервисами
6. пользователю возвращается идентификатор процесса.
7. процесс продолжает исполняться после отправки ответу пользователя, все, что скрипт пишет в stdout и stderr, сразу же сохраняется в бд, когда процесс завершился, рутины аккуратно завершают свою работу, очищают информацию о запущенном процессе в контейнере, и помечают в базе данных команду как выполненную

Благодаря такой схеме можно без особых усилий выполнить дополнительное требования в виде остановки команды

## Consequences

Довольно сложная схема, которую можно было бы упростить, но не понятна формулировка "создание команды", поэтому и приходится придумывать не самые логичные решения.
